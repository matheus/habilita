<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Aluno - Habilita CFC</title>

    <!-- Fonte Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #6754e2;
            --primary-hover: #5645b9;
            --text-dark: #2d3748;
            --text-light: #5a6376;
            --bg-light: #f9faff;
            --border-color: #e2e8f0;
            --danger-color: #d9534f;
            --success-color: #16d39a;
            --warning-color: #ffb703;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            color: var(--text-light);
        }
        body.loading {
            display: none; /* Esconde conteúdo até verificar login */
        }
        .header {
            background-color: #fff;
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .user-info {
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .user-info span {
            font-weight: 600;
            margin-right: 15px;
        }
        #logout-button {
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        #logout-button:hover {
            background-color: var(--danger-color);
            color: #fff;
        }
        .container {
            max-width: 1140px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            padding: 10px 18px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #e2e2e2;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: #fff;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .page-header a {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 15px;
        }
        .page-header h1 {
            margin: 0;
            color: var(--text-dark);
        }

        /* Layout em Colunas */
        .details-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        
        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .card h2 {
            margin: 0 0 20px 0;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Formulários */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-dark);
        }
        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
        }
        
        /* Listas de Eventos */
        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .event-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        .event-list li:last-child {
            border-bottom: none;
        }
        
        .form-add-event {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .form-add-event.single {
             grid-template-columns: 3fr 1fr;
        }
         .form-add-event.single button {
             grid-column: 2 / 3;
         }
        .form-add-event input,
        .form-add-event select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }
        .form-add-event button {
            grid-column: 1 / -1;
            padding: 8px;
            font-size: 14px;
        }

        @media (max-width: 992px) {
            .details-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="loading"> <!-- Começa escondido -->

    <header class="header">
        <div class="logo">HABILITA CFC</div>
        <div class="user-info">
            <span id="user-display-name">Carregando...</span>
            <button id="logout-button">Sair</button>
        </div>
    </header>

    <main class="container">
        
        <div class="page-header">
            <a href="dashboard.html">&larr; Voltar</a>
            <h1 id="aluno-nome-header">Carregando...</h1>
        </div>

        <div class="details-layout">
            
            <!-- Coluna Principal (Formulários) -->
            <div class="main-column">
                
                <!-- Dados Cadastrais -->
                <div class="card">
                    <h2>Dados Cadastrais</h2>
                    <form id="form-aluno-detalhes">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="nome">Nome Completo</label>
                                <input type="text" id="nome" name="nome" required>
                            </div>
                            <!-- ... (campos restantes do formulário) ... -->
                            <div class="form-group"> <label for="cpf">CPF</label> <input type="text" id="cpf" name="cpf"> </div>
                            <div class="form-group"> <label for="rg">RG</label> <input type="text" id="rg" name="rg"> </div>
                            <div class="form-group"> <label for="data_nascimento">Data de Nascimento</label> <input type="date" id="data_nascimento" name="data_nascimento"> </div>
                            <div class="form-group"> <label for="telefone">Telefone (com DDD)</label> <input type="tel" id="telefone" name="telefone"> </div>
                            <div class="form-group full-width"> <label for="email">Email</label> <input type="email" id="email" name="email"> </div>
                            <div class="form-group full-width"> <label for="endereco">Endereço</label> <input type="text" id="endereco" name="endereco"> </div>
                            <div class="form-group">
                                <label for="servico">Serviço Contratado</label>
                                <select id="servico" name="servico" required>
                                    <option value="">Selecione...</option>
                                    <option value="AB">AB (Carro e Moto)</option>
                                    <option value="A">A (Moto)</option>
                                    <option value="B">B (Carro)</option>
                                    <option value="Adição A">Adição A</option>
                                    <option value="Adição B">Adição B</option>
                                    <option value="Adição C">Adição C</option>
                                    <option value="Adição D">Adição D</option>
                                    <option value="Adição E">Adição E</option>
                                    <option value="Reabilitação">Reabilitação</option>
                                </select>
                            </div>
                            <div class="form-group"> <label for="valor_pago">Valor Pago (R$)</label> <input type="number" step="0.01" id="valor_pago" name="valor_pago"> </div>
                            <div class="form-group"> <label for="renach">RENACH</label> <input type="text" id="renach" name="renach"> </div>
                            <div class="form-group"> <label for="data_exame_medico">Data Exame Médico</label> <input type="date" id="data_exame_medico" name="data_exame_medico"> </div>
                            <div class="form-group"> <label for="data_exame_psicotecnico">Data Exame Psicotécnico</label> <input type="date" id="data_exame_psicotecnico" name="data_exame_psicotecnico"> </div>
                            <div class="form-group"> <label for="data_teorico_inicio">Início Curso Teórico</label> <input type="date" id="data_teorico_inicio" name="data_teorico_inicio"> </div>
                            <div class="form-group"> <label for="data_teorico_fim">Fim Curso Teórico</label> <input type="date" id="data_teorico_fim" name="data_teorico_fim"> </div>
                            <div class="form-group"> <label for="data_exame_teorico">Data Exame Teórico</label> <input type="date" id="data_exame_teorico" name="data_exame_teorico"> </div>
                        </div>
                        <button type="submit" class="btn-primary" style="margin-top: 20px;">Salvar Alterações</button>
                    </form>
                </div>
            </div>

            <!-- Coluna Lateral (Eventos) -->
            <div class="sidebar-column">

                <!-- Reprovas Teóricas -->
                <div class="card">
                    <h2>Exame Teórico</h2>
                    <ul id="lista-reprovas" class="event-list">
                        <li>Nenhum evento registrado.</li>
                    </ul>
                    <form id="form-add-reprova" class="form-add-event single">
                        <input type="date" id="reprova-data" required>
                        <button type="submit" class="btn-primary">Add Reprova</button>
                    </form>
                </div>

                <!-- Aulas Práticas -->
                <div class="card">
                    <h2>Aulas Práticas</h2>
                    <ul id="lista-aulas" class="event-list">
                       <li>Nenhum evento registrado.</li>
                    </ul>
                    <form id="form-add-aula" class="form-add-event">
                        <select id="aula-tipo" required>
                            <option value="Início">Início</option>
                            <option value="Fim">Fim</option>
                        </select>
                        <input type="date" id="aula-data" required>
                        <select id="aula-categoria" required>
                            <option value="A">A (Moto)</option>
                            <option value="B">B (Carro)</option>
                            <option value="C">C (Caminhão)</option>
                            <option value="D">D (Ônibus)</option>
                            <option value="E">E (Carreta)</option>
                        </select>
                        <input type="text" id="aula-instrutor" placeholder="Instrutor (Opcional)">
                        <input type="text" id="aula-veiculo" placeholder="Veículo (Opcional)">
                        <button type="submit" class="btn-primary">Adicionar Aula</button>
                    </form>
                </div>
                
                <!-- Exames Práticos -->
                <div class="card">
                    <h2>Exames Práticos</h2>
                    <ul id="lista-exames" class="event-list">
                       <li>Nenhum evento registrado.</li>
                    </ul>
                    <form id="form-add-exame" class="form-add-event">
                        <select id="exame-status" required>
                            <option value="Agendamento">Agendamento</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Reprovado">Reprovado</option>
                            <option value="Ausente">Ausente</option>
                        </select>
                        <input type="date" id="exame-data" required>
                        <select id="exame-categoria" required>
                           <option value="A">A (Moto)</option>
                            <option value="B">B (Carro)</option>
                            <option value="C">C (Caminhão)</option>
                            <option value="D">D (Ônibus)</option>
                            <option value="E">E (Carreta)</option>
                        </select>
                        <button type="submit" class="btn-primary">Adicionar Exame</button>
                    </form>
                </div>

            </div>
        </div>
    </main>


    <!-- SDKs do Firebase (Sintaxe de Módulo ES) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBl4xyH36EE4gX9mNUazHDxmDPkt-foVuI",
            authDomain: "habilita-cfc.firebaseapp.com",
            projectId: "habilita-cfc", 
            storageBucket: "habilita-cfc.firebasestorage.app",
            messagingSenderId: "695924938189",
            appId: "1:695924938189:web:befcb3ff6888ccf677a084",
            measurementId: "G-XRQNJ8SWQY"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const userNameSpan = document.getElementById('user-display-name');
        const logoutButton = document.getElementById('logout-button');
        const alunoNomeHeader = document.getElementById('aluno-nome-header');
        const formAlunoDetalhes = document.getElementById('form-aluno-detalhes');

        let currentUserId = null;
        let currentAlunoId = null;
        let currentAlunoDocRef = null;

        // --- 1. PEGAR ID DA URL ---
        function getAlunoIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // --- 2. CONTROLE DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userNameSpan.textContent = user.displayName || user.email;
                document.body.classList.remove('loading');

                currentAlunoId = getAlunoIdFromURL();
                if (currentAlunoId) {
                    // Se temos o ID do usuário E o ID do aluno, carregamos os dados
                    currentAlunoDocRef = doc(db, 'cfcs', currentUserId, 'alunos', currentAlunoId);
                    loadAlunoDetalhes();
                } else {
                    console.error("Nenhum ID de aluno encontrado na URL.");
                    alert("Aluno não encontrado.");
                    window.location.href = 'dashboard.html';
                }

            } else {
                currentUserId = null;
                console.log('Acesso negado. Redirecionando para login...');
                window.location.href = 'index.html';
            }
        });

        // --- 3. CARREGAR DADOS DO ALUNO ---
        async function loadAlunoDetalhes() {
            try {
                const docSnap = await getDoc(currentAlunoDocRef);

                if (docSnap.exists()) {
                    const aluno = docSnap.data();
                    
                    // Preenche o formulário principal
                    alunoNomeHeader.textContent = aluno.nome;
                    // Itera sobre os campos do formulário e preenche
                    const inputs = formAlunoDetalhes.elements;
                    for (const input of inputs) {
                        if (input.name && aluno[input.name] !== undefined) {
                            input.value = aluno[input.name];
                        }
                    }

                    // Renderiza as listas
                    renderizarLista(aluno.reprovas_teorico || [], 'lista-reprovas', formatarReprova);
                    renderizarLista(aluno.aulas_praticas || [], 'lista-aulas', formatarAula);
                    renderizarLista(aluno.exames_praticos || [], 'lista-exames', formatarExame);

                } else {
                    console.error("Aluno não encontrado no banco de dados.");
                    alert("Aluno não encontrado.");
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error("Erro ao carregar dados do aluno:", error);
            }
        }
        
        // --- 4. ATUALIZAR DADOS CADASTRAIS ---
        formAlunoDetalhes.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(formAlunoDetalhes);
            const dataToUpdate = Object.fromEntries(formData.entries());

            try {
                await updateDoc(currentAlunoDocRef, dataToUpdate);
                console.log("Dados do aluno atualizados!");
                // (Opcional) Mostrar um feedback de sucesso
            } catch (error) {
                console.error("Erro ao atualizar dados:", error);
            }
        });

        // --- 5. RENDERIZAR LISTAS DE EVENTOS ---
        
        // Função genérica para renderizar qualquer lista
        function renderizarLista(lista, listElementId, formatador) {
            const listElement = document.getElementById(listElementId);
            if (!lista || lista.length === 0) {
                listElement.innerHTML = '<li>Nenhum evento registrado.</li>';
                return;
            }
            listElement.innerHTML = ''; // Limpa a lista
            lista.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${formatador(item)}</span>
                    <button class="btn-danger btn-remover-item" data-index="${index}">&times;</button>
                `;
                listElement.appendChild(li);
            });
        }
        
        // Funções de formatação específicas
        function formatarReprova(item) {
            return `Reprova em: ${new Date(item.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`;
        }
        function formatarAula(item) {
            return `[${item.tipo}] ${item.categoria} - ${new Date(item.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} (${item.instrutor || 'N/A'})`;
        }
        function formatarExame(item) {
             const statusCor = {
                'Aprovado': 'var(--success-color)',
                'Reprovado': 'var(--danger-color)',
                'Ausente': 'var(--warning-color)',
                'Agendamento': 'var(--text-light)'
            };
            return `<strong style="color: ${statusCor[item.status] || 'black'}">[${item.status}]</strong> ${item.categoria} - ${new Date(item.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`;
        }


        // --- 6. ADICIONAR ITENS NAS LISTAS (EVENTOS) ---

        // Adicionar Reprova Teórica
        document.getElementById('form-add-reprova').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dataInput = document.getElementById('reprova-data');
            if (!dataInput.value) return;

            const novoEvento = { data: dataInput.value };
            await updateDoc(currentAlunoDocRef, {
                reprovas_teorico: arrayUnion(novoEvento)
            });
            e.target.reset();
            loadAlunoDetalhes(); // Recarrega os dados para mostrar a atualização
        });

        // Adicionar Aula Prática
        document.getElementById('form-add-aula').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('aula-data').value;
            const tipo = document.getElementById('aula-tipo').value;
            const categoria = document.getElementById('aula-categoria').value;
            const instrutor = document.getElementById('aula-instrutor').value;
            const veiculo = document.getElementById('aula-veiculo').value;

            if (!data || !tipo || !categoria) return;

            const novoEvento = { data, tipo, categoria, instrutor, veiculo };
            await updateDoc(currentAlunoDocRef, {
                aulas_praticas: arrayUnion(novoEvento)
            });
            e.target.reset();
            loadAlunoDetalhes();
        });

        // Adicionar Exame Prático
        document.getElementById('form-add-exame').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = document.getElementById('exame-data').value;
            const status = document.getElementById('exame-status').value;
            const categoria = document.getElementById('exame-categoria').value;

            if (!data || !status || !categoria) return;

            const novoEvento = { data, status, categoria };
            await updateDoc(currentAlunoDocRef, {
                exames_praticos: arrayUnion(novoEvento)
            });
            e.target.reset();
            loadAlunoDetalhes();
        });


        // --- LÓGICA DE LOGOUT ---
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

    </script>

</body>
</html>
